openapi: 3.0.3
info:
  title: Real-time Chat Module API
  description: |
    REST and WebSocket API for one-on-one real-time messaging between users.

    **Authentication**: All endpoints require JWT Bearer token.

    **WebSocket Events**: See WebSocket events section for real-time communication.
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com

servers:
  - url: http://localhost:3000
    description: Local development server
  - url: https://api.example.com
    description: Production server

tags:
  - name: Conversations
    description: Conversation management and history
  - name: Messages
    description: Message operations
  - name: WebSocket
    description: Real-time WebSocket events (Socket.IO)

paths:
  /conversations:
    get:
      tags:
        - Conversations
      summary: Get user's conversation list
      description: |
        Returns all conversations for the authenticated user, sorted by most recent activity.
        Includes last message preview and unread count for each conversation.
      operationId: getConversations
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          description: Page number (1-indexed)
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: Number of conversations per page
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: Conversation list retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationListResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /conversations/{conversationId}:
    get:
      tags:
        - Conversations
      summary: Get conversation details
      description: Returns conversation metadata and participant information
      operationId: getConversation
      security:
        - bearerAuth: []
      parameters:
        - name: conversationId
          in: path
          required: true
          description: Unique conversation identifier
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Conversation details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /conversations/{conversationId}/messages:
    get:
      tags:
        - Conversations
      summary: Get conversation message history
      description: |
        Returns paginated message history for a conversation in chronological order.
        Loads 50 messages per page by default. Marks returned messages as read.
      operationId: getConversationHistory
      security:
        - bearerAuth: []
      parameters:
        - name: conversationId
          in: path
          required: true
          description: Unique conversation identifier
          schema:
            type: string
            format: uuid
        - name: before
          in: query
          description: Get messages before this message ID (for pagination)
          required: false
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          description: Number of messages to return
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
      responses:
        '200':
          description: Message history retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageListResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /conversations/with/{userId}:
    post:
      tags:
        - Conversations
      summary: Get or create conversation with user
      description: |
        Returns existing conversation with specified user, or creates new conversation if none exists.
        Idempotent operation - safe to call multiple times.
      operationId: getOrCreateConversation
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: User ID to start conversation with
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Existing conversation returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationResponse'
        '201':
          description: New conversation created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationResponse'
        '400':
          description: Bad request (cannot message self)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: error
                error:
                  code: CHAT_INVALID_PARTICIPANT
                  message: Cannot create conversation with yourself
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Target user not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: error
                error:
                  code: USER_NOT_FOUND
                  message: User not found

  /messages/search:
    post:
      tags:
        - Messages
      summary: Search messages across conversations
      description: |
        Full-text search across all user's messages. Returns results ranked by relevance.
        Limited to 50 results per query.
      operationId: searchMessages
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchMessagesRequest'
      responses:
        '200':
          description: Search results returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageSearchResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /messages/mark-read:
    patch:
      tags:
        - Messages
      summary: Mark messages as read
      description: |
        Marks all messages in a conversation as read for the authenticated user.
        Idempotent operation - safe to call multiple times.
      operationId: markMessagesAsRead
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MarkMessagesReadRequest'
      responses:
        '200':
          description: Messages marked as read successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [success]
                  data:
                    type: object
                    properties:
                      markedCount:
                        type: integer
                        description: Number of messages marked as read
                        example: 5
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token from /auth/login endpoint

  schemas:
    # Response wrappers
    ConversationListResponse:
      type: object
      required:
        - status
        - data
        - meta
      properties:
        status:
          type: string
          enum: [success]
          example: success
        data:
          type: object
          required:
            - conversations
            - pagination
          properties:
            conversations:
              type: array
              items:
                $ref: '#/components/schemas/ConversationDto'
            pagination:
              $ref: '#/components/schemas/PaginationMeta'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    ConversationResponse:
      type: object
      required:
        - status
        - data
        - meta
      properties:
        status:
          type: string
          enum: [success]
          example: success
        data:
          $ref: '#/components/schemas/ConversationDto'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    MessageListResponse:
      type: object
      required:
        - status
        - data
        - meta
      properties:
        status:
          type: string
          enum: [success]
          example: success
        data:
          type: object
          required:
            - messages
            - hasMore
          properties:
            messages:
              type: array
              items:
                $ref: '#/components/schemas/MessageDto'
            hasMore:
              type: boolean
              description: Whether more messages exist before the oldest returned message
              example: true
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    MessageSearchResponse:
      type: object
      required:
        - status
        - data
        - meta
      properties:
        status:
          type: string
          enum: [success]
          example: success
        data:
          type: object
          required:
            - results
            - total
          properties:
            results:
              type: array
              items:
                $ref: '#/components/schemas/MessageSearchResult'
            total:
              type: integer
              description: Total number of matches found
              example: 42
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    ErrorResponse:
      type: object
      required:
        - status
        - error
        - meta
      properties:
        status:
          type: string
          enum: [error]
          example: error
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Machine-readable error code
              example: CHAT_RATE_LIMIT_EXCEEDED
            message:
              type: string
              description: Human-readable error message
              example: You are sending messages too quickly
            details:
              type: object
              description: Additional error context
              additionalProperties: true
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    # Domain models
    ConversationDto:
      type: object
      required:
        - id
        - participants
        - unreadCount
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174000
        participants:
          type: array
          minItems: 2
          maxItems: 2
          items:
            $ref: '#/components/schemas/ParticipantDto'
        lastMessage:
          allOf:
            - $ref: '#/components/schemas/LastMessageDto'
            - nullable: true
          description: Most recent message in conversation (null if no messages yet)
        unreadCount:
          type: integer
          minimum: 0
          description: Number of unread messages for current user
          example: 3
        createdAt:
          type: string
          format: date-time
          example: '2025-11-13T10:30:00Z'
        updatedAt:
          type: string
          format: date-time
          description: Timestamp of last message in conversation
          example: '2025-11-13T15:45:00Z'

    LastMessageDto:
      type: object
      required:
        - id
        - content
        - senderId
        - createdAt
      properties:
        id:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174000
        content:
          type: string
          maxLength: 100
          description: Message content (truncated to 100 chars for preview)
          example: Hello, how are you?
        senderId:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174002
        createdAt:
          type: string
          format: date-time
          example: '2025-11-13T10:30:00Z'

    ParticipantDto:
      type: object
      required:
        - id
        - username
      properties:
        id:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174000
        username:
          type: string
          example: john_doe
        avatarUrl:
          type: string
          format: uri
          nullable: true
          example: https://example.com/avatars/john_doe.jpg

    MessageDto:
      type: object
      required:
        - id
        - conversationId
        - senderId
        - content
        - status
        - createdAt
      properties:
        id:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174000
        conversationId:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174001
        senderId:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174002
        content:
          type: string
          minLength: 1
          maxLength: 5000
          example: Hello, how are you?
        status:
          type: string
          enum: [sent, delivered, read]
          example: read
        createdAt:
          type: string
          format: date-time
          example: '2025-11-13T10:30:00Z'
        deliveredAt:
          type: string
          format: date-time
          nullable: true
          example: '2025-11-13T10:30:02Z'
        readAt:
          type: string
          format: date-time
          nullable: true
          example: '2025-11-13T10:35:00Z'

    MessageSearchResult:
      allOf:
        - $ref: '#/components/schemas/MessageDto'
        - type: object
          properties:
            conversationId:
              type: string
              format: uuid
              description: Conversation containing this message
            rank:
              type: number
              format: float
              description: Search relevance score
              example: 0.892

    SearchMessagesRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          minLength: 1
          maxLength: 100
          description: Search keywords
          example: hello world
        limit:
          type: integer
          minimum: 1
          maximum: 50
          default: 50
          description: Maximum number of results

    MarkMessagesReadRequest:
      type: object
      required:
        - conversationId
      properties:
        conversationId:
          type: string
          format: uuid
          description: Conversation ID to mark messages as read
          example: 123e4567-e89b-12d3-a456-426614174000

    # Metadata
    ResponseMeta:
      type: object
      required:
        - timestamp
        - requestId
      properties:
        timestamp:
          type: string
          format: date-time
          example: '2025-11-13T10:30:00Z'
        requestId:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174000

    PaginationMeta:
      type: object
      required:
        - currentPage
        - totalPages
        - pageSize
        - totalItems
      properties:
        currentPage:
          type: integer
          minimum: 1
          example: 1
        totalPages:
          type: integer
          minimum: 0
          example: 10
        pageSize:
          type: integer
          minimum: 1
          example: 20
        totalItems:
          type: integer
          minimum: 0
          example: 187

  responses:
    UnauthorizedError:
      description: Authentication required or token invalid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            status: error
            error:
              code: UNAUTHORIZED
              message: Authentication required
            meta:
              timestamp: '2025-11-13T10:30:00Z'
              requestId: 123e4567-e89b-12d3-a456-426614174000

    ForbiddenError:
      description: User does not have access to this resource
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            status: error
            error:
              code: CHAT_FORBIDDEN
              message: You are not a participant in this conversation
            meta:
              timestamp: '2025-11-13T10:30:00Z'
              requestId: 123e4567-e89b-12d3-a456-426614174000

    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            status: error
            error:
              code: CHAT_CONVERSATION_NOT_FOUND
              message: Conversation not found
            meta:
              timestamp: '2025-11-13T10:30:00Z'
              requestId: 123e4567-e89b-12d3-a456-426614174000

    BadRequestError:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            status: error
            error:
              code: VALIDATION_ERROR
              message: Validation failed
              details:
                query:
                  - must not be empty
            meta:
              timestamp: '2025-11-13T10:30:00Z'
              requestId: 123e4567-e89b-12d3-a456-426614174000

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            status: error
            error:
              code: INTERNAL_SERVER_ERROR
              message: An unexpected error occurred
            meta:
              timestamp: '2025-11-13T10:30:00Z'
              requestId: 123e4567-e89b-12d3-a456-426614174000
